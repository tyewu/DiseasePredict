<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>肝癌生存预测</title>
    <link href="../static/css/bootstrap.css" type="text/css" rel="stylesheet">
    <link href="../static/css/toastr.css" type="text/css" rel="stylesheet">
    <link href="../static/css/ich.css" type="text/css" rel="stylesheet">
    <script src="../static/js/jquery-1.11.3.min.js" type="text/javascript"></script>
    <script src="../static/js/bootstrap.min.js" type="text/javascript"></script>
    <script src="../static/js/toastr.js" type="text/javascript"></script>
    <script src="../static/js/toastpopup.js" type="text/javascript"></script>
    <style>

    </style>
</head>
<body>
<div class="outer_container">
    <div style="display: flex">
        <!-- <img src="../static/img/301logo.jpg" class="logo"> -->
        <div>
            <!-- <h3>Calculation tool for predicting the death probability of liver cancer patients--A1group</h3>
            <h4 class="zh_title">A1组肝癌患者死亡结局预测工具</h4> -->
            <h3 class="zh_title">Calculation tool for predicting the death probability of liver cancer patients -- TACE group</h3>
        </div>
    </div>
    <div class="container">
        <div class="left_container">
            <div class="form-horizontal">

                <div class="span">
                    <label class="col-sm-8 control-label">Local therapy</label>
                    <div class="col-sm-2">
                        <select name="feature" id="therapy" data-style="btn-info" class="select-span">
                            <option value="0">Absence</option>
                            <option value="1">Presence</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Age</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Age" data-style="btn-info" class="select-span">
                            <option value="1">≤65</option>
                            <option value="2">>65</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Gender</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Gender" data-style="btn-info" class="select-span">
                            <option value="0">Woman</option>
                            <option value="1">Man</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Comorbidity</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Comorbidity" data-style="btn-info" class="select-span">
                            <option value="0">Absence</option>
                            <option value="1">Presence</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Etiology</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Etiology" data-style="btn-info" class="select-span">
                            <option value="0">Absence</option>
                            <option value="1">HBV</option>
                            <option value="2">HCV</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Ascites</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Ascites" data-style="btn-info" class="select-span">
                            <option value="0">Absence</option>
                            <option value="1">Presence</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Tumor diameter</label>
                    <div class="col-sm-2">
                        <select name="feature" id="diameter" data-style="btn-info" class="select-span">
                            <option value="1">≤5</option>
                            <option value="2">[5-10]</option>
                            <option value="3">>10</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Tumor number</label>
                    <div class="col-sm-2">
                        <select name="feature" id="number" data-style="btn-info" class="select-span">
                            <option value="1">[1-3]</option>
                            <option value="2">>3</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Vascular invasion</label>
                    <div class="col-sm-2">
                        <select name="feature" id="invasion" data-style="btn-info" class="select-span">
                            <option value="0">Absence</option>
                            <option value="1">Presence</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Metastasis</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Metastasis" data-style="btn-info" class="select-span">
                            <option value="0">Absence</option>
                            <option value="1">Presence</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">BCLC</label>
                    <div class="col-sm-2">
                        <select name="feature" id="BCLC" data-style="btn-info" class="select-span">
                            <option value="1">A</option>
                            <option value="2">B</option>
                            <option value="3">C</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">ALB (g/L)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="ALB" data-style="btn-info" class="select-span">
                            <option value="1">≤35</option>
                            <option value="2">>35</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">ALT (g/L)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="ALT" data-style="btn-info" class="select-span">
                            <option value="1">≤40</option>
                            <option value="2">>40</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">AST (g/L)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="AST" data-style="btn-info" class="select-span">
                            <option value="1">≤40</option>
                            <option value="2">>40</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">TBIL (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="TBIL" data-style="btn-info" class="select-span">
                            <option value="1">≤17.1</option>
                            <option value="2">>17.1</option>
                        </select>
                    </div>
                </div>


                <div class="span">
                    <label class="col-sm-8 control-label">ALBI grade</label>
                    <div class="col-sm-2">
                        <select name="feature" id="ALBI" data-style="btn-info" class="select-span">
                            <option value="1">1</option>
                            <option value="2">2</option>
                            <option value="3">3</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">INR (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="INR" data-style="btn-info" class="select-span">
                            <option value="1">≤1</option>
                            <option value="2">>1</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">PLT (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="PLT" data-style="btn-info" class="select-span">
                            <option value="0">≤100</option>
                            <option value="1">>100</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">CRP (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="CRP" data-style="btn-info" class="select-span">
                            <option value="1">≤30</option>
                            <option value="2">>30</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Neu (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Neu" data-style="btn-info" class="select-span">
                            <option value="1">≤5.5</option>
                            <option value="2">>5.5</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">Ly (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="Ly" data-style="btn-info" class="select-span">
                            <option value="1">≤1.5</option>
                            <option value="2">>1.5</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">NLR</label>
                    <div class="col-sm-2">
                        <select name="feature" id="NLR" data-style="btn-info" class="select-span">
                            <option value="1">≤4</option>
                            <option value="2">>4</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">AFP (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="AFP" data-style="btn-info" class="select-span">
                            <option value="1">≤400</option>
                            <option value="2">>400</option>
                        </select>
                    </div>
                </div>

                <div class="span">
                    <label class="col-sm-8 control-label">PIVKA (ng/ml)</label>
                    <div class="col-sm-2">
                        <select name="feature" id="PIVKA" data-style="btn-info" class="select-span">
                            <option value="1">≤400</option>
                            <option value="2">>400</option>
                        </select>
                    </div>
                </div>

            </div>
        </div>
        <div class="right_container">
            <div class="ring">
                <canvas id="tutorial"></canvas>
                <span class="fraction"><span class="number">0</span> <span class="small">%</span> </span>
                <div class="title">
                    <h4>Estimated probability of tumor</h4>
                    <!-- <h5>预测概率</h5> -->
                </div>
            </div>
            <div>
                <button class="btn btn-primary" style="top:400px;position: absolute;margin: 80px 30px;width:250px"
                        onclick="calc()">Calculate
                </button>
            </div>
        </div>
    </div>
</div>
<div class="footer">
    <div class="copyright">
        Copyright @ Chinese PLA General Hospital and DHC Mediway Technology Co.,Ltd. All rights reserved.
    </div>
</div>
<script type="text/javascript">

    function calc() {
        var vals = {}
        var flag = true
        $("*[name='feature']").each(function (i, obj) {
            var objVal = $(obj).val();
            var objID = $(obj).attr("id")
            if (isNaN(parseFloat(objVal)) || (parseFloat(objVal) < 0)) {
                toastr.warning("请正确输入" + objID + "的值")
                $("#" + objID).focus()
                flag = false
                return false
            }
            vals[objID] = objVal
        });
        $("select[name='feature']").each(function (i, obj) {
            var objVal = $(obj).val();
            var objID = $(obj).attr("id")
            vals[objID] = objVal
        });

        if (flag) {
            $.ajax({
                type: "POST",
                url: "/hnzl_calc/",
                data: {
                    "model": "suba2",
                    "val": JSON.stringify(vals),
                },
                dataType: "json",
                async: false,
                success: function (data) {
                    var prob = data["res"]
                    if (prob !== -1) {
                        initRing(prob) //80.34%->8034
                    } else {
                        toastr.warning("出了一些问题，请重试")
                    }
                },
            });
        }
    }

    function initRing(now) {
        let radius = 95 //外环半径
        let thickness = 10 //圆环厚度
        let innerRadius = radius - thickness //内环半径
        let startAngle = -90 //开始角度
        let endAngle = 180 //结束角度
        let x = 0 //圆心x坐标
        let y = 0 //圆心y坐标
        let canvas = document.getElementById('tutorial');
        canvas.width = 300;
        canvas.height = 300;

        let ctx = canvas.getContext('2d');
        ctx.translate(canvas.width / 2, canvas.height / 2); //将绘图原点移到画布中央
        ctx.rotate(angle2Radian(225)) //将画布旋转225度
        ctx.fillStyle = "#eee"; //初始填充颜色
        renderRing(startAngle, endAngle, ctx, x, y, radius, innerRadius, thickness)

        //进度条颜色
        var lingrad = ctx.createLinearGradient(0, 0, 150, 0);
        lingrad.addColorStop(0, '#00ABEB');
        lingrad.addColorStop(1, '#fff');
        ctx.fillStyle = lingrad

        //开始绘画

        let tempAngle = startAngle
        let total = 10000 //总分
        // let now = 9093 //当前分数
        let percent = (now / total).toFixed(4) //百分比
        let twoEndAngle = percent * 270 + startAngle
        let step = (twoEndAngle - startAngle) / 80
        let numberSpan = document.querySelector('.number')
        let inter = setInterval(() => {
            if (tempAngle > twoEndAngle) {
                clearInterval(inter)
            } else {
                numberSpan.innerText = (percent * 100).toFixed(2)
                tempAngle += step
            }
            renderRing(startAngle, tempAngle, ctx, x, y, radius, innerRadius, thickness)
        }, 20)
    }

    //渲染函数
    function renderRing(startAngle, endAngle, ctx, x, y, radius, innerRadius, thickness) {
        ctx.beginPath();

        //绘制外环
        ctx.arc(x, y, radius, angle2Radian(startAngle), angle2Radian(endAngle))

        //计算外环与内环第一个连接处的中心坐标
        let oneCtrlPoint = calcRingPoint(x, y, innerRadius + thickness / 2, endAngle)

        //绘制外环与内环第一个连接处的圆环
        ctx.arc(oneCtrlPoint.x, oneCtrlPoint.y, thickness / 2, angle2Radian(-90), angle2Radian(270))

        // //绘制内环
        ctx.arc(x, y, innerRadius, angle2Radian(endAngle), angle2Radian(startAngle), true)

        //计算外环与内环第二个连接处的中心坐标
        let twoCtrlPoint = calcRingPoint(x, y, innerRadius + thickness / 2, startAngle)

        //绘制外环与内环第二个连接处的圆环
        ctx.arc(twoCtrlPoint.x, twoCtrlPoint.y, thickness / 2, angle2Radian(-90), angle2Radian(270))

        ctx.fill()
        // ctx.stroke()
    }


    //计算圆环上点的坐标
    function calcRingPoint(x, y, radius, angle) {
        let res = {}
        res.x = x + radius * Math.cos(angle * Math.PI / 180)
        res.y = y + radius * Math.sin(angle * Math.PI / 180)
        return res
    }

    //弧度转角度
    function radian2Angle(radian) {
        return 180 * radian / Math.PI
    }

    //角度转弧度
    function angle2Radian(angle) {
        return angle * Math.PI / 180
    }

    // initRing(0)

</script>

</body>
</html>